# 車両検出カウントプログラム
# 概要
## 制作理由
アイフォンで写真をとると、人物検出してくれたり、監視カメラで動体検知をしたりすることにすごく興味がありまた、
学校で制作できるタイミングがあったため作成した。
## 目標
ウェブ上で車両検出したい動画をアップロードし、検出した車両数を表示する
# 実装方法
バックエンドは Python/Flask で、アップロードされた動画の処理や YOLO モデルでの車両検出、通過カウントなどのロジックを担当している。  
フロントエンドは HTML テンプレートで、ユーザーが動画をアップロードしたり、結果の動画やカウントを表示する画面部分を担当している。  
それぞれ独立させるつもりだったが短いしまあいっかと役割だけ分けている、具体的な方法は後述。
## ためした車両検出方法
### opencvだけを使った方法
- 方法  
動画のフレームごとの差分から動体を検知し、IDを付与しトラッキングする（重複カウントをさせないため）
ある一定のラインを越えたらカウントするようにする

- 利点  
とにかく処理が速い、数分であれば一瞬で終わる

- 問題点  
人と車の違いが見分けれない、大きさで判断しようとしたが画像の端のほうで車も小さく判定されてしまう
### yolo,opencvを使った方法
- 方法  
物体検出AIのyoloを使用して車両検出、yolo公式にある関数objectcounter（入力画像、ここを越えたらカウントをさせたいラインを渡すとカウントしてくれる）
を使用しカウントする

- 利点  
物体検知やカウントなどしたいことの関数が用意されており、とても実装が簡単

- 問題点  
自分が外付けではなくintel CPU内臓のGPUを使用していたため一番軽いyoloのモデルでも処理時間が動画の長さのほとんど２倍近くかかる  
精度的な観点からもう少し重いyoloのモデルを使う必要がある
### openvino,opencvを使った方法
- 方法  
yoloのモデルをintel向けに最適化し高速推論ができるopenvinoを使用して物体検知をする  
トラッキング、カウントはobjectcounterを参考に自作する

- 利点  
yoloのモデルをそのまま使うより約５倍ほど高速、精度もあまりかわらない  

- 問題点  
トラッキング、カウントを自作する必要がある  

__この方法が一番精度がよかったため使用した__
## 具体的な実装
### バックエンドの実装

- Flask による Web サーバー
- `/` : 動画アップロード画面を返す
- `/upload` : POST で動画を受け取り処理
- 動画処理の流れ:  
  1 openvinoでフレームごとに車両検出  
  2 `SimpleTracker` による簡易トラッキング（ID管理）  
  3 中央線を横切った車両を左右方向でカウント  
  4 バウンディングボックス・ID・カウントを描画して動画出力  

- __SimpleTracker__:  
  ・前フレームの位置と距離で同じ物体か判定  
  ・新規物体には新しい ID を割り当て  
  ・フレーム間の距離が `max_distance` を超える場合は新規物体とみなす  
### フロントエンド（index.html）

- HTML フォームで動画をアップロード
- アップロード時に「処理中」メッセージを表示（JavaScript で制御）
- 処理後、出力動画を `<video>` タグで再生
- 検出された車両数を表示
- CSS でフォームや動画の見た目を整えている
# 伝えたいこと
## 工夫点
- 強いGPU買ったら重いモデルを使用することができて精度も速度もよくなるが  できるだけ今の環境でやれることをやろうとしopenvinoを見つけ、速度を向上することができた。
  openvinoは数行のコードでyoloのモデルから変換することができ、簡単だった。
- フレームを２、３個とばしすると、精度が落ちることなく処理速度がかなり​
　向上した、しかしかなり速い車両が現れるとトラッキングできなかった​
- 動画のサイズが640×480だったがこれを320×320にすることで速度が約４倍に​
　なった
- 処理後の動画のエンコーディング方法がh264でないとwebで表示できず、opencvがh264を書き出せないためDLLをいれてできるようにした
## 苦労した点
- yoloの精度向上、処理速度向上、について調べるとき英語が多く大変だった
- カウントする際重複判定、判定漏れがまだすこしあり、解決したい​
# 使用技術
- バックエンド: Python, Flask
- フロントエンド: HTML, CSS, JavaScript
- 物体検出: yolo (ultralytics)
- 動画処理: opencv, numpy
# 動作について
- 学校で使用した動画は公開できないため、outpuフォルダにイメージのみのせている。
- ローカルで動かす際このリポジトリのファイルだけでなくhttps://github.com/cisco/openh264DLL
  をダウンロードしpythonがインストールされているとこにおかないといけない
- 処理性能の例:
  - 1時間の動画を処理した場合の誤差率（検出した車両数 ÷ 実際の車両数）は **約 3.7%**
  - 処理時間は **約 30分**だった
# AIについて
- objectcounterから簡易的な自作する際にchatgptに頼ることがかなり多かった
